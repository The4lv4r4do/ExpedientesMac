name: Compilar para MacOS (Compatible Big Sur)

# Se ejecuta manualmente (botón) o cada vez que subes cambios a la rama 'main'
on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    # Usamos 'macos-13' (Intel) en lugar de 'latest'.
    # Esto asegura que la App funcione en Macs Intel viejas y en Macs M1/M2/M3 nuevas (vía Rosetta).
    runs-on: macos-13

    steps:
    - name: Descargar código del repositorio
      uses: actions/checkout@v4

    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13' # Pon la versión que uses (3.9, 3.10, 3.11, etc.)

    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install pyinstaller

    - name: Crear Ejecutable con PyInstaller
      # --windowed: Para que sea una App de mac y no abra consola negra
      # --onefile: (Opcional) Intenta meter todo en un archivo, pero en Mac suele ser mejor dejarlo como carpeta .app
      # 'env' define la versión MÍNIMA de macOS necesaria. Ponemos '11.0' para cubrir Big Sur.
      env:
        MACOSX_DEPLOYMENT_TARGET: '11.0'
      run: |
        # Añadimos --target-arch x86_64 para asegurar arquitectura Intel
        pyinstaller --name "Expedientes_V4" --windowed --clean --noconfirm --target-arch x86_64 main.py

    - name: Empaquetar en ZIP
      run: |
        cd dist
        zip -r Expedientes_V4_Mac.zip Expedientes_V4.app

    - name: Subir el archivo resultante
      uses: actions/upload-artifact@v4
      with:
        name: App-MacOS-Ejecutable
        path: dist/Expedientes_V4_Mac.zip
